<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Talkk</title>
<link rel="stylesheet" href="/static/home/home.css">
</head>

<body class="dark">

<script>
/* stars */
for(let i=0;i<60;i++){
 let s=document.createElement("div");
 s.className="star";
 s.style.left=Math.random()*100+"%";
 s.style.top=Math.random()*100+"%";
 document.body.appendChild(s);
}
</script>

<!-- bubbles -->
<div class="bubble" style="width:200px;height:200px;left:10%;top:20%;background:#8f00ff;"></div>
<div class="bubble" style="width:260px;height:260px;left:70%;top:30%;background:#00f2fe;"></div>
<div class="bubble" style="width:150px;height:150px;left:40%;top:70%;background:#ff0080;"></div>

<div class="top-bar">
  <div class="user">{{ user }}</div>
  <input class="search" placeholder="Search users">
  <div class="bell-wrap" onclick="toggleNotify(event)">
    <div class="bell" id="bell">ğŸ””</div>
    <div class="badge" id="badge"></div>
  </div>
</div>

<!-- ğŸ”” Notifications Panel -->
<div class="notify-panel" id="notify" onclick="event.stopPropagation()">
  <h3>Notifications</h3>

  <div id="notifyList" onclick="event.stopPropagation()"></div>

  <!-- UNDO BAR -->
  <div id="undoBar" onclick="event.stopPropagation()" style="
    display:none;
    position:sticky;
    bottom:10px;
    margin-top:15px;
    background:rgba(0,200,255,.25);
    backdrop-filter:blur(15px);
    padding:12px;
    border-radius:15px;
    text-align:center;
    font-weight:bold;
  ">
    Message deleted â€” <span id="undoBtn" style="color:cyan;cursor:pointer">UNDO</span>
  </div>

  <div id="emptyMsg" style="text-align:center;opacity:.6;margin-top:30px;">
    No new notifications
  </div>
</div>

<!-- ğŸ“© Message View -->
<div class="message-view" id="messageView">
  <div class="message-card">
    <div style="cursor:pointer;color:cyan;margin-bottom:15px" onclick="closeMessage()">â† Back</div>
    <div id="messageText"></div>
  </div>
</div>

<!-- âš™ Settings -->
<div class="settings-panel" id="settings" onclick="event.stopPropagation()">
  <div class="setting-btn" onclick="toggleDark(event)">ğŸŒ— Toggle Theme</div>
  <div class="setting-btn" onclick="window.location.href='/logout'">ğŸšª Logout</div>
</div>

<div class="bottom-nav">
  <div class="nav-btn" onclick="window.location.href='/video'">ğŸ“¹<span>Video</span></div>
  <div class="nav-btn">ğŸ’¬<span>Chat</span></div>
  <div class="nav-btn">ğŸ‘¤<span>Profile</span></div>
  <div class="nav-btn" onclick="toggleSettings(event)">âš™ï¸<span>Settings</span></div>
</div>

<script>
const notify=document.getElementById("notify")
const notifyList=document.getElementById("notifyList")
const badge=document.getElementById("badge")
const bell=document.getElementById("bell")
const settings=document.getElementById("settings")
const emptyMsg=document.getElementById("emptyMsg")

let notifications=[]
let deleteTimer=null

async function loadNotifications(){
  const r=await fetch("/api/notifications")
  const d=await r.json()
  notifications=d.notifications || []
  render()
  updateBadge()
}

function updateBadge(){
  const unread=notifications.filter(n=>!n.read).length
  badge.innerText=unread
  badge.style.display=unread?"block":"none"
}

function render(){
  notifyList.innerHTML=""
  if(notifications.length===0){
    emptyMsg.style.display="block"
    return
  }
  emptyMsg.style.display="none"

  notifications.forEach(n=>{
    const card=document.createElement("div")
    card.className="notify-card "+(n.read?"":"unread")
    card.innerHTML=`${n.text}<div class="delete-btn">ğŸ—‘</div>`
    notifyList.appendChild(card)

    addSwipe(card,n.id,n.text)
  })
}

/* iOS-style swipe + desktop right click */
function addSwipe(card,id,text){
  let startX=0

  // mobile
  card.addEventListener("touchstart",e=>{
    startX=e.touches[0].clientX
  })

  card.addEventListener("touchmove",e=>{
    let diff = e.touches[0].clientX - startX
    if(diff < -50) card.classList.add("swipe-left")
  })

  card.addEventListener("touchend",()=>{
    if(card.classList.contains("swipe-left")){
      deleteWithUndo(id,card)
    }
  })

  // desktop
  card.addEventListener("contextmenu",e=>{
    e.preventDefault()
    deleteWithUndo(id,card)
  })

  // open message
  card.onclick=()=>{
    openMessage(text)
  }
}

/* Delete animation */
function deleteWithUndo(id,card){
  card.style.transform="translateX(-100%)"
  card.style.opacity="0"
  showUndo(id)
}

/* Undo bar */
function showUndo(id){
  let bar=document.getElementById("undoBar")
  bar.style.display="flex"

  let timer=setTimeout(()=>{
    fetch("/api/delete/"+id,{method:"POST"}).then(()=>{
      loadNotifications()
      bar.style.display="none"
    })
  },2000)

  document.getElementById("undoBtn").onclick=()=>{
    clearTimeout(timer)
    bar.style.display="none"
    loadNotifications()
  }
}

/* Bell */
function toggleNotify(e){
  e.stopPropagation()
  bell.classList.add("shake")
  setTimeout(()=>bell.classList.remove("shake"),400)
  notify.classList.toggle("show")

  if(notify.classList.contains("show")){
    fetch("/api/read_all",{method:"POST"})
    loadNotifications()
  }
}

/* Message viewer */
function openMessage(text){
  notify.classList.remove("show")
  document.getElementById("messageText").innerText=text
  document.getElementById("messageView").classList.add("show")
}

function closeMessage(){
  document.getElementById("messageView").classList.remove("show")
  notify.classList.add("show")
}

/* Settings */
function toggleSettings(e){
  e.stopPropagation()
  settings.classList.toggle("show")
}

/* Dark */
function toggleDark(e){
  e.stopPropagation()
  document.body.classList.toggle("dark")
  document.body.classList.toggle("light")
}

/* Close only outside */
document.body.addEventListener("click",()=>{
  notify.classList.remove("show")
  settings.classList.remove("show")
})

loadNotifications()
</script>

</body>
</html>
