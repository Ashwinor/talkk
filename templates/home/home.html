<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talkk</title>
<link rel="stylesheet" href="/static/home/home.css">
</head>
<body class="dark">

<!-- â­ Stars -->
<script>
for(let i=0;i<60;i++){
  const s=document.createElement("div");
  s.className="star";
  s.style.left=Math.random()*100+"%";
  s.style.top=Math.random()*100+"%";
  document.body.appendChild(s);
}
</script>

<!-- ğŸ«§ Bubbles -->
<div class="bubble" style="width:200px;height:200px;left:10%;top:20%;background:#8f00ff;"></div>
<div class="bubble" style="width:260px;height:260px;left:70%;top:30%;background:#00f2fe;"></div>
<div class="bubble" style="width:150px;height:150px;left:40%;top:70%;background:#ff0080;"></div>

<!-- ğŸ” Top Bar -->
<div class="top-bar">
  <div class="user">{{ user }}</div>
  <input class="search" placeholder="Search users">
  <div class="bell-wrap" onclick="toggleNotify(event)">
    <div class="bell" id="bell">ğŸ””</div>
    <div class="badge" id="badge"></div>
  </div>
</div>

<!-- ğŸ”” Notifications Panel -->
<div class="notify-panel" id="notify" onclick="event.stopPropagation()">
  <h3>Notifications 
    <span id="clearAll" style="float:right; cursor:pointer; color:cyan; font-size:14px;">Clear All</span>
  </h3>
  <div id="notifyList"></div>

  <div id="undoBar" style="display:none; position:sticky; bottom:10px; margin-top:15px; background:rgba(0,200,255,.25); backdrop-filter:blur(15px); padding:12px; border-radius:15px; text-align:center; font-weight:bold;">
    Message deleted â€” <span id="undoBtn" style="color:cyan; cursor:pointer;">UNDO</span>
  </div>

  <div id="emptyMsg" style="text-align:center;opacity:.6;margin-top:30px;">No new notifications</div>
</div>

<!-- ğŸ’¬ Message View -->
<div class="message-view" id="messageView">
  <div class="message-card">
    <div style="cursor:pointer;color:cyan;margin-bottom:15px" onclick="closeMessage()">â† Back</div>
    <div id="messageText"></div>
  </div>
</div>

<!-- ğŸ¥ Video Panel -->
<div class="message-view" id="videoView">
  <div class="message-card">
    <div style="cursor:pointer;color:cyan;margin-bottom:15px" onclick="closeVideo()">â† Back</div>
    <h3>Connect</h3>
    <p>Type your region</p>
    <input id="region" placeholder="Your region" style="width:100%; padding:12px; border-radius:15px; border:none; margin:15px 0; background:rgba(255,255,255,.2); color:white;">
    <button onclick="alert('No users found')" style="width:100%; padding:12px; border:none; border-radius:20px; background:linear-gradient(90deg,cyan,magenta); color:black; font-weight:bold; cursor:pointer; box-shadow:0 0 25px cyan;">Connect</button>
  </div>
</div>

<!-- ğŸ”» Bottom Dock -->
<div class="bottom-nav">
  <div class="nav-btn" onclick="openVideo()">ğŸ“¹<span>Video</span></div>
  <div class="nav-btn">ğŸ’¬<span>Chat</span></div>
  <div class="nav-btn">ğŸ‘¤<span>Profile</span></div>
  <div class="nav-btn" onclick="toggleSettings()">âš™ï¸<span>Settings</span></div>
</div>

<!-- âš™ Glass Settings Panel -->
<div class="settings-panel" id="settings" onclick="toggleSettings()">
  <div class="settings-box" onclick="event.stopPropagation()">
    <div style="cursor:pointer;color:cyan;margin-bottom:20px" onclick="toggleSettings()">â† Back</div>
    <div class="settings-btn" onclick="toggleDark()">ğŸŒ— Toggle Dark Mode</div>
    <div class="settings-btn" onclick="window.location.href='/logout'">ğŸšª Logout</div>
  </div>
</div>

<!-- ğŸ§  Scripts -->
<script>
const notify = document.getElementById("notify");
const notifyList = document.getElementById("notifyList");
const badge = document.getElementById("badge");
const bell = document.getElementById("bell");
const messageView = document.getElementById("messageView");
const messageText = document.getElementById("messageText");
const clearAllBtn = document.getElementById("clearAll");

let notifications = [];
let undoActive = false;
let currentView = null;
let prevView = null;

// Load Notifications
async function loadNotifications(){
  const r = await fetch("/api/notifications");
  const d = await r.json();
  notifications = d.notifications || [];
  renderNotifications();
  updateBadge();
}

// Update badge count
function updateBadge(){
  const unread = notifications.filter(n => !n.read).length;
  badge.innerText = unread;
  badge.style.display = unread ? "block" : "none";
}

// Render notifications
function renderNotifications(){
  notifyList.innerHTML = "";
  if(!notifications.length){
    document.getElementById("emptyMsg").style.display = "block";
    return;
  }
  document.getElementById("emptyMsg").style.display = "none";

  notifications.forEach(n => {
    const card = document.createElement("div");
    card.className = "notify-card" + (n.read ? "" : " unread");
    card.innerHTML = `${n.text}<div class="delete-btn">ğŸ—‘</div>`;
    notifyList.appendChild(card);
    addSwipe(card, n.id, n.text, n.read);
  });
}

// Swipe / delete logic
function addSwipe(card, id, text, read){
  let startX = 0;
  card.addEventListener("touchstart", e => startX = e.touches[0].clientX);
  card.addEventListener("touchmove", e => { if(e.touches[0].clientX - startX < -50) card.classList.add("swipe-left"); });
  card.addEventListener("touchend", () => { if(card.classList.contains("swipe-left")) deleteWithUndo(id, card); });
  card.addEventListener("contextmenu", e => { e.preventDefault(); card.classList.toggle("swipe-left"); });
  card.querySelector(".delete-btn").onclick = e => { e.stopPropagation(); deleteWithUndo(id, card); };

  // Open message
  card.onclick = () => { if(!card.classList.contains("swipe-left")) openMessage(id, text, card); };
}

// Delete with undo
function deleteWithUndo(id, card){
  if(undoActive) return;
  undoActive = true;
  card.style.transform = "translateX(-100%)";
  card.style.opacity = "0";
  document.getElementById("undoBar").style.display = "flex";

  const timer = setTimeout(() => {
    fetch("/api/delete/"+id,{method:"POST"}).then(() => {
      undoActive = false;
      document.getElementById("undoBar").style.display = "none";
      loadNotifications();
    });
  }, 3000);

  document.getElementById("undoBtn").onclick = () => {
    clearTimeout(timer);
    undoActive = false;
    document.getElementById("undoBar").style.display = "none";
    loadNotifications();
  };
}

// Open message
function openMessage(id, text, card){
  prevView = currentView;
  messageText.innerText = text;
  messageView.classList.add("show");
  currentView = 'message';

  const n = notifications.find(n => n.id === id);
  if(n && !n.read){
    n.read = true;
    card.classList.remove("unread");
    updateBadge();
  }
}

// Close message
function closeMessage(){
  messageView.classList.remove("show");
  currentView = prevView;
  prevView = null;
}

// Toggle notification panel
function toggleNotify(e){
  e.stopPropagation();
  bell.classList.add("shake");
  setTimeout(()=>bell.classList.remove("shake"),400);
  const show = !notify.classList.contains("show");
  notify.classList.toggle("show", show);

  if(show){
    currentView = 'notify';
    renderNotifications();
  } else currentView = null;
}

// Settings & dark mode
function toggleSettings(){
  const s = document.getElementById("settings");
  const show = !s.classList.contains("show");
  s.classList.toggle("show", show);
  currentView = show ? 'settings' : null;
}
function toggleDark(){
  document.body.classList.toggle("dark");
  document.body.classList.toggle("light");
}

function openVideo(){
  prevView=currentView; 
  document.getElementById("videoView").classList.add("show"); 
  currentView='video';
}
function closeVideo(){
  document.getElementById("videoView").classList.remove("show"); 
  currentView=prevView; 
  prevView=null;
}

// Clear All notifications
clearAllBtn.onclick = () => {
  if(notifications.length === 0) return;
  const cards = document.querySelectorAll("#notifyList .notify-card");
  cards.forEach((card, index) => {
    setTimeout(() => { card.style.animation = "dustOut 0.6s forwards"; }, index * 100);
  });
  setTimeout(() => {
    const ids = notifications.map(n => n.id);
    ids.forEach(id => fetch("/api/delete/"+id, { method: "POST" }));
    notifications = [];
    renderNotifications();
    updateBadge();
  }, cards.length * 100 + 600);
}

// Click outside closes panels
document.body.addEventListener("click", ()=>{
  if(currentView !== 'notify') notify.classList.remove("show");
  if(currentView !== 'settings') document.getElementById("settings").classList.remove("show");
});

// Initialize
loadNotifications();
</script>

</body>
</html>
